{% extends "base.html" %}
{% block content %}
<h2>{{ bt.name }}</h2>

<p class="muted">{{ bt.description|default:"" }}</p>

<div class="row" style="gap:24px;">
  <div style="flex:1;">
    <h3>Paramètres</h3>
    <table class="table">
      <tbody>
        <tr><th>Scénario</th><td>{{ bt.scenario.name }}</td></tr>
        <tr><th>Période</th><td>{% if bt.start_date %}{{ bt.start_date }}{% else %}—{% endif %} → {% if bt.end_date %}{{ bt.end_date }}{% else %}—{% endif %}</td></tr>
        <tr><th>CP (capital total)</th><td>{{ bt.capital_total }}</td></tr>
        <tr><th>CT (capital par ticker)</th><td>{{ bt.capital_per_ticker }}</td></tr>
        <tr><th>X (seuil ratio_p %)</th><td>{{ bt.ratio_threshold }}</td></tr>
        <tr>
          <th>Tous les tickers du scénario</th>
          <td>
            {% if bt.include_all_tickers %}
              Oui <span class="muted">(ignore ratio_p ≥ X)</span>
            {% else %}
              Non <span class="muted">(éligibilité via ratio_p ≥ X)</span>
            {% endif %}
          </td>
        </tr>
        <tr><th>Lignes (buy/sell)</th><td>
  {% if bt.signal_lines %}
    <table>
      <thead><tr><th>#</th><th>BUY</th><th>SELL</th></tr></thead>
      <tbody>
      {% for line in bt.signal_lines %}
        <tr>
          <td>{{ forloop.counter }}</td>
          <td>{{ line.buy }}</td>
          <td>{{ line.sell }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  {% else %}
    —
  {% endif %}
</td></tr>
        <tr><th>Clôture fin de backtest</th><td>{% if bt.close_positions_at_end %}Oui{% else %}Non{% endif %}</td></tr>
        <tr><th>Statut</th><td>{{ bt.status }}</td></tr>
      </tbody>
    </table>
    <div class="card" style="margin-top:12px;">
  <strong>Suivi des traitements</strong>
  <div class="muted" style="margin-top:6px;">Chaque bouton lance un job en arrière-plan. Suis l’état ici ou sur la page <a href="{% url 'jobs_page' %}">Traitements</a>.</div>
  <table style="margin-top:10px;">
    <thead><tr><th>Étape</th><th>Dernier état</th><th>Date</th><th>Détails</th></tr></thead>
    <tbody>
      {% with j=latest_by_type.FETCH_BARS %}
      <tr>
        <td>1) Récupération données</td>
        <td>{% if j %}<span class="pill">{{ j.status }}</span>{% else %}<span class="muted">—</span>{% endif %}</td>
        <td>{% if j %}{{ j.created_at|date:"Y-m-d H:i" }}{% else %}<span class="muted">—</span>{% endif %}</td>
        <td>{% if j %}{{ j.message|default:j.error }}{% else %}<span class="muted">Aucun job lancé</span>{% endif %}</td>
      </tr>
      {% endwith %}
      {% with j=latest_by_type.COMPUTE_METRICS %}
      <tr>
        <td>2) Calcul indicateurs</td>
        <td>{% if j %}<span class="pill">{{ j.status }}</span>{% else %}<span class="muted">—</span>{% endif %}</td>
        <td>{% if j %}{{ j.created_at|date:"Y-m-d H:i" }}{% else %}<span class="muted">—</span>{% endif %}</td>
        <td>{% if j %}{{ j.message|default:j.error }}{% else %}<span class="muted">Aucun job lancé</span>{% endif %}</td>
      </tr>
      {% endwith %}
      {% with j=latest_by_type.RUN_BACKTEST %}
      <tr>
        <td>3) Backtest</td>
        <td>{% if j %}<span class="pill">{{ j.status }}</span>{% else %}<span class="muted">—</span>{% endif %}</td>
        <td>{% if j %}{{ j.created_at|date:"Y-m-d H:i" }}{% else %}<span class="muted">—</span>{% endif %}</td>
        <td>{% if j %}{{ j.message|default:j.error }}{% else %}<span class="muted">Aucun job lancé</span>{% endif %}</td>
      </tr>
      {% endwith %}
    </tbody>
  </table>
</div>

<div style="margin-top:12px; display:flex; gap:8px; align-items:center;">
      <form method="post" action="{% url 'backtest_fetch_data' bt.id %}">
        {% csrf_token %}
        <button class="btn" type="submit" {% if bt.status == 'RUNNING' %}disabled{% endif %}>Récupérer données</button>
      </form>
      <form method="post" action="{% url 'backtest_compute_metrics' bt.id %}">
        {% csrf_token %}
        <button class="btn" type="submit" {% if bt.status == 'RUNNING' %}disabled{% endif %}>Calculer indicateurs</button>
      </form>
      <form method="post" action="{% url 'backtest_run' bt.id %}">
        {% csrf_token %}
        <button class="btn" type="submit" {% if bt.status == 'RUNNING' %}disabled{% endif %}>Lancer / Relancer</button>
      </form>

      <a class="btn" href="{% url 'backtest_update' bt.id %}" {% if bt.status == 'RUNNING' %}style="pointer-events:none; opacity:0.6;"{% endif %}>
        Modifier
      </a>
      <form method="post" action="{% url 'backtest_delete' bt.id %}" style="margin-left:8px;" onsubmit="return confirm('Supprimer ce backtest ? Cette action est irréversible.');">
        {% csrf_token %}
        <button class="btn danger" type="submit" {% if bt.status == 'RUNNING' %}disabled{% endif %}>Supprimer</button>
      </form>
      {% if bt.results %}
        <a class="btn" style="margin-left:8px;" href="{% url 'backtest_results' bt.id %}">Voir résultats</a>
        <a class="btn" style="margin-left:8px;" href="{% url 'backtest_export_excel_compact' bt.id %}">Exporter Excel (compact Sheets)</a>
        <a class="btn" style="margin-left:8px;" href="{% url 'backtest_export_excel' bt.id %}">Exporter Excel</a>
      {% endif %}
      {% if bt.status == 'RUNNING' %}<span class="muted">En cours… rafraîchis la page dans quelques secondes.</span>{% endif %}
    </div>

    {% if jobs %}
      <div class="card" style="margin-top:12px;">
        <strong>Traitements liés à ce backtest</strong>
        <div class="muted" style="margin-top:6px;">Astuce : pour une vue globale, ouvre la page <a href="{% url 'jobs_page' %}">Traitements</a>.</div>
        <table style="margin-top:10px;">
          <thead>
            <tr>
              <th>Date</th>
              <th>Type</th>
              <th>Status</th>
              <th>Message</th>
            </tr>
          </thead>
          <tbody>
            {% for j in jobs %}
              <tr>
                <td>{{ j.created_at }}</td>
                <td>{{ j.job_type }}</td>
                <td>{{ j.status }}</td>
                <td>
                  <div style="white-space:pre-wrap;">{{ j.message|default:j.error }}</div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endif %}
    {% if bt.error_message %}
      <div class="card" style="border-color:#f2b1b1; margin-top:10px;">
        <strong>Erreur :</strong>
        <pre style="white-space:pre-wrap; margin:8px 0 0 0;">{{ bt.error_message }}</pre>
      </div>
    {% endif %}
  </div>

  <div style="flex:1;">
    <h3>Univers (snapshot)</h3>
    {% if bt.universe_snapshot %}
      <div class="card" style="max-height:420px; overflow:auto;">
        <table class="table">
          <thead><tr><th>Ticker</th><th>Exchange</th></tr></thead>
          <tbody>
            {% for s in bt.universe_snapshot %}
              <tr><td>{{ s.ticker }}</td><td>{{ s.exchange }}</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="muted">Snapshot non disponible.</p>
    {% endif %}
  </div>
</div>

<hr/>

<h3>Résultats</h3>
{% if bt.status == 'DONE' and bt.results %}
  <div class="card">
    <strong>Synthèse</strong>
    <pre style="white-space:pre-wrap; margin-top:8px;">{{ bt.results|safe }}</pre>
  </div>

  {% if bt.results.prep %}
    <h4>Préparation des données</h4>
    <ul>
      <li>fetch bars: {{ bt.results.prep.did_fetch_bars }}</li>
      <li>compute metrics: {{ bt.results.prep.did_compute_metrics }}</li>
      <li>notes: {{ bt.results.prep.notes|length }}</li>
    </ul>
    {% if bt.results.prep.notes %}
      <ul>
        {% for n in bt.results.prep.notes %}
          <li>{{ n }}</li>
        {% endfor %}
      </ul>
    {% endif %}
  {% endif %}

  {% if bt.results.logs %}
    <h4>Logs (dernières lignes)</h4>
    <pre style="white-space: pre-wrap;">{% for l in bt.results.logs %}{{ l }}
{% endfor %}</pre>
  {% endif %}
{% elif bt.status == 'RUNNING' %}
  <p class="muted">Backtest en cours…</p>
{% else %}
  <p class="muted">Aucun résultat pour l’instant. Clique sur <strong>Lancer / Relancer</strong>.</p>
{% endif %}

<p>
  <a class="btn" href="{% url 'backtests_page' %}">← Retour</a>
</p>
{% endblock %}