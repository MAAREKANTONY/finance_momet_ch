{% extends "base.html" %}
{% block content %}
<div class="row" style="justify-content:space-between; align-items:center;">
  <h2>Study — {{ study.name }}</h2>
  <div class="muted">Scenario interne #{{ study.scenario.id }}</div>
</div>

{% comment %}
  Actions rapides
  - Calculs (scénario de la study)
  - Backtest (fetch / compute / run / results)
  - Alertes (send now)
  NOTE: actions side-effects are POST.
{% endcomment %}
<div class="card" style="display:flex; flex-wrap:wrap; gap:8px; align-items:center;">
  <strong style="margin-right:8px;">Actions</strong>

  <form method="post" action="{% url 'study_compute_now' study.id %}">
    {% csrf_token %}
    <button class="btn" type="submit">Compute (incr.)</button>
  </form>
  <form method="post" action="{% url 'study_recompute_now' study.id %}">
    {% csrf_token %}
    <button class="btn" type="submit">Recompute complet</button>
  </form>

  {% if backtest_form %}
    <span style="margin:0 6px;" class="muted">|</span>
    <form method="post" action="{% url 'backtest_fetch_data' study.backtest.id %}">
      {% csrf_token %}
      <button class="btn" type="submit">Backtest: Fetch data</button>
    </form>
    <form method="post" action="{% url 'backtest_compute_metrics' study.backtest.id %}">
      {% csrf_token %}
      <button class="btn" type="submit">Backtest: Compute</button>
    </form>
    <form method="post" action="{% url 'backtest_run' study.backtest.id %}">
      {% csrf_token %}
      <button class="btn" type="submit">Backtest: Run</button>
    </form>
    <a class="btn" href="{% url 'backtest_results' study.backtest.id %}">Voir résultats</a>
  {% endif %}

  {% if study.alert %}
    <span style="margin:0 6px;" class="muted">|</span>
    <form method="post" action="{% url 'alert_definition_send_now' study.alert.id %}">
      {% csrf_token %}
      <button class="btn" type="submit">Envoyer alertes maintenant</button>
    </form>
  {% endif %}
</div>

<div class="card">
  <h3>Tickers (appliquer un univers)</h3>
  <p class="muted">Appliquer un univers copie ses tickers dans la Study (sans modifier l'univers).</p>
  <form method="post" action="{% url 'study_apply_universe' study.id %}">
    {% csrf_token %}
    <select name="universe_id">
      <option value="">— choisir un univers —</option>
      {% for u in universes %}
        <option value="{{ u.id }}">{{ u.name }} ({{ u.symbols.count }})</option>
      {% endfor %}
    </select>
    <select name="mode">
      <option value="add">Ajouter</option>
      <option value="replace">Remplacer</option>
    </select>
    <button class="btn" type="submit">Appliquer</button>
  </form>
</div>

<div class="card">
  <form method="post">
    {% csrf_token %}

    <h3>Informations study</h3>
    {{ meta_form.non_field_errors }}
    <div class="grid2">
      <div>
        <label><strong>Nom</strong></label><br/>
        {{ meta_form.name }}
      </div>
      <div>
        <label><strong>Description</strong></label><br/>
        {{ meta_form.description }}
      </div>
    </div>

    <hr/>
    <h3>Paramètres indicateurs</h3>
    {{ scenario_form.non_field_errors }}
    <div class="grid2">
      <div>
        <label>a</label><br/>{{ scenario_form.a }}
      </div>
      <div>
        <label>b</label><br/>{{ scenario_form.b }}
      </div>
      <div>
        <label>c</label><br/>{{ scenario_form.c }}
      </div>
      <div>
        <label>d</label><br/>{{ scenario_form.d }}
      </div>
      <div>
        <label>e</label><br/>{{ scenario_form.e }}
      </div>
      <div>
        <label>vc</label><br/>{{ scenario_form.vc }}
      </div>
      <div>
        <label>fl</label><br/>{{ scenario_form.fl }}
      </div>
      <div>
        <label>n1</label><br/>{{ scenario_form.n1 }}
      </div>
      <div>
        <label>n2</label><br/>{{ scenario_form.n2 }}
      </div>
      <div>
        <label>n3</label><br/>{{ scenario_form.n3 }}
      </div>
      <div>
        <label>n4</label><br/>{{ scenario_form.n4 }}
      </div>
      <div>
        <label>n5</label><br/>{{ scenario_form.n5 }}
      </div>
      <div>
        <label>k2j</label><br/>{{ scenario_form.k2j }}
      </div>
      <div>
        <label>cr</label><br/>{{ scenario_form.cr }}
      </div>
      <div>
        <label>m_v</label><br/>{{ scenario_form.m_v }}
      </div>
      <div>
        <label>history_years</label><br/>{{ scenario_form.history_years }}
      </div>
    </div>

    <hr/>
    <h3>Tickers</h3>
    <div style="margin-top:12px;">
      {{ scenario_form.symbols }}
    </div>

    <hr/>
    <h3>Alertes</h3>
    {% if alert_form %}
      {{ alert_form.non_field_errors }}
      <div class="grid2">
        <div>
          <label><strong>Nom</strong></label><br/>
          {{ alert_form.name }}
        </div>
        <div>
          <label><strong>Actif</strong></label><br/>
          {{ alert_form.is_active }}
        </div>
      </div>
      <div style="margin-top:12px;">
        <label><strong>Description</strong></label><br/>
        {{ alert_form.description }}
      </div>
      <div class="grid2" style="margin-top:12px;">
        <div>
          <label><strong>Lignes (codes)</strong></label><br/>
          {{ alert_form.alert_codes_multi }}
          <div class="muted">Laisser vide = tous les signaux.</div>
        </div>
        <div>
          <label><strong>Destinataires</strong></label><br/>
          {{ alert_form.recipients }}
        </div>
      </div>
      <div class="grid2" style="margin-top:12px;">
        <div>
          <label><strong>Heure d'envoi</strong></label><br/>
          {{ alert_form.send_hour }} : {{ alert_form.send_minute }}
        </div>
        <div>
          <label><strong>Timezone</strong></label><br/>
          {{ alert_form.timezone }}
        </div>
      </div>
    {% else %}
      <p class="muted">Aucune configuration d'alertes pour cette Study.</p>
      <button class="btn" type="submit" formaction="{% url 'study_create_alert' study.id %}" formmethod="post">
        + Créer une configuration d'alertes
      </button>
    {% endif %}

    <hr/>
    <h3>Backtest</h3>
    {% if backtest_form %}
      {{ backtest_form.non_field_errors }}
      <div class="grid2">
        <div>
          <label><strong>Nom</strong></label><br/>
          {{ backtest_form.name }}
        </div>
        <div>
          <label><strong>Inclure toutes les actions</strong></label><br/>
          {{ backtest_form.include_all_tickers }}
        </div>
      </div>
      <div style="margin-top:12px;">
        <label><strong>Description</strong></label><br/>
        {{ backtest_form.description }}
      </div>
      <div class="grid2" style="margin-top:12px;">
        <div>
          <label><strong>Date début</strong></label><br/>
          {{ backtest_form.start_date }}
        </div>
        <div>
          <label><strong>Date fin</strong></label><br/>
          {{ backtest_form.end_date }}
        </div>
      </div>
      <div class="grid2" style="margin-top:12px;">
        <div>
          <label><strong>Capital total (CP)</strong></label><br/>
          {{ backtest_form.capital_total }}
        </div>
        <div>
          <label><strong>Capital par action (CT)</strong></label><br/>
          {{ backtest_form.capital_per_ticker }}
        </div>
      </div>
      <div class="grid2" style="margin-top:12px;">
        <div>
          <label><strong>Seuil ratio_p (X)</strong></label><br/>
          {{ backtest_form.ratio_threshold }}
        </div>
        <div>
          <label><strong>Clôturer en fin de période</strong></label><br/>
          {{ backtest_form.close_positions_at_end }}
        </div>
      </div>
      <div style="margin-top:12px;">
        <label><strong>Lignes de déclenchement</strong></label><br/>
        <div class="muted">Définis les paires <code>BUY</code>/<code>SELL</code>. Le JSON est généré automatiquement.</div>

        {# Hidden JSON field submitted to Django #}
        <textarea id="id_signal_lines" name="signal_lines" style="display:none;"></textarea>
        {{ backtest_form.instance.signal_lines|json_script:"signalLinesData" }}

        <table class="table" id="signalLinesTable" style="margin-top:10px;">
          <thead>
            <tr>
              <th style="width:45%;">BUY</th>
              <th style="width:45%;">SELL</th>
              <th style="width:10%;"></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div style="display:flex; gap:8px; align-items:center;">
          <button class="btn" type="button" id="addSignalLineBtn">+ Ajouter une ligne</button>
          <button class="btn" type="button" id="resetSignalLinesBtn">Reset</button>
          <span class="muted">Ex: BUY=A2f / SELL=B2f</span>
        </div>

        <datalist id="signalCodes">
          <option value="A1"></option><option value="B1"></option>
          <option value="C1"></option><option value="D1"></option>
          <option value="E1"></option><option value="F1"></option>
          <option value="G1"></option><option value="H1"></option>
          <option value="A2f"></option><option value="B2f"></option>
        </datalist>
      </div>
    {% else %}
      <p class="muted">Aucune configuration de backtest pour cette Study.</p>
      <button class="btn" type="submit" formaction="{% url 'study_create_backtest' study.id %}" formmethod="post">
        + Créer une configuration de backtest
      </button>
    {% endif %}

    <hr/>
    <button class="btn" type="submit">Enregistrer</button>
    <a class="btn" href="{% url 'studies_page' %}">Retour</a>
  </form>
</div>

<script>
(function() {
  function safeParse(jsonText) {
    try {
      if (!jsonText) return [];
      const v = JSON.parse(jsonText);
      return Array.isArray(v) ? v : [];
    } catch (e) {
      return [];
    }
  }

  const hidden = document.getElementById('id_signal_lines');
  const tbody = document.querySelector('#signalLinesTable tbody');
  const addBtn = document.getElementById('addSignalLineBtn');
  const resetBtn = document.getElementById('resetSignalLinesBtn');

  if (!hidden || !tbody || !addBtn || !resetBtn) return;

  function rowTemplate(buy, sell) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="text" class="input" placeholder="ex: A2f" value="${buy || ''}" list="signalCodes" data-role="buy"/></td>
      <td><input type="text" class="input" placeholder="ex: B2f" value="${sell || ''}" list="signalCodes" data-role="sell"/></td>
      <td style="text-align:right;"><button class="btn" type="button" data-action="remove">✕</button></td>
    `;
    tr.querySelector('[data-action="remove"]').addEventListener('click', function() {
      tr.remove();
      syncToHidden();
    });
    tr.querySelectorAll('input').forEach(inp => inp.addEventListener('input', syncToHidden));
    return tr;
  }

  function syncToHidden() {
    const rows = Array.from(tbody.querySelectorAll('tr'));
    const payload = rows.map(r => {
      const buy = (r.querySelector('[data-role="buy"]').value || '').trim();
      const sell = (r.querySelector('[data-role="sell"]').value || '').trim();
      return { buy, sell };
    }).filter(x => x.buy || x.sell);
    hidden.value = JSON.stringify(payload);
  }

  function renderFromHidden() {
    tbody.innerHTML = '';
    const data = safeParse(hidden.value);
    if (data.length === 0) {
      tbody.appendChild(rowTemplate('A2f', 'B2f'));
    } else {
      data.forEach(item => tbody.appendChild(rowTemplate(item.buy, item.sell)));
    }
    syncToHidden();
  }

  addBtn.addEventListener('click', function() {
    tbody.appendChild(rowTemplate('', ''));
    syncToHidden();
  });
  resetBtn.addEventListener('click', function() {
    hidden.value = '[]';
    renderFromHidden();
  });

  // Ensure hidden JSON is in sync before form submit
  const form = hidden.closest('form');
  if (form) {
    form.addEventListener('submit', function() {
      syncToHidden();
    });
  }

  // Initialize from server-side JSON
  try {
    const initial = JSON.parse(document.getElementById('signalLinesData').textContent || '[]');
    hidden.value = JSON.stringify(Array.isArray(initial) ? initial : []);
  } catch (e) {
    hidden.value = '[]';
  }
  renderFromHidden();
})();
</script>

<div class="card">
  <h3>Traçabilité</h3>
  <div class="muted">
    {% if study.origin_scenario %}Import scénario : #{{ study.origin_scenario.id }} — {{ study.origin_scenario.name }}<br/>{% endif %}
    {% if study.origin_universe %}Import univers : #{{ study.origin_universe.id }} — {{ study.origin_universe.name }}<br/>{% endif %}
  </div>
</div>
{% endblock %}
