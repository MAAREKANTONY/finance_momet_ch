{% extends "base.html" %}
{% block content %}
<h2>Aide — indicateurs & alertes</h2>

<div class="card">
  <p class="muted">
    Cette page décrit les formules utilisées par l’application pour calculer les indicateurs et générer les alertes.
    Les notations suivent les champs visibles dans les exports (DailyBars / DailyMetrics). Les paramètres sont ceux du <em>Scénario</em>.
  </p>

  <details open>
    <summary><strong>1) Prix composite P</strong></summary>
    <div style="margin-top:10px;">
      <p><strong>Inputs (DailyBar)</strong> : F = Close, H = High, L = Low, O = Open</p>
      <p><strong>Paramètres scénario</strong> : a, b, c, d</p>
      <pre>P = (a*F + b*H + c*L + d*O) / (a+b+c+d)</pre>
    </div>
  </details>

  <details>
    <summary><strong>2) Fenêtres N1 / N2 : M, X, M1, X1</strong></summary>
    <div style="margin-top:10px;">
      <p><strong>Paramètres scénario</strong> : N1, N2</p>
      <ul>
        <li><strong>M</strong> = max des <strong>N1</strong> dernières valeurs de P (strictement avant le jour courant)</li>
        <li><strong>X</strong> = min des <strong>N1</strong> dernières valeurs de P</li>
        <li><strong>M1</strong> = moyenne des <strong>N2</strong> dernières valeurs de M</li>
        <li><strong>X1</strong> = moyenne des <strong>N2</strong> dernières valeurs de X</li>
      </ul>
      <p class="muted">Note: si l’historique n’est pas suffisant pour N1/N2, l’app enregistre ce qui est disponible et complète plus tard.</p>
    </div>
  </details>

  <details>
    <summary><strong>3) T, Q, S</strong></summary>
    <div style="margin-top:10px;">
      <p><strong>Paramètre scénario</strong> : e</p>
      <pre>T = (M1 - X1) / e
Q = M1 - T
S = M1 + T</pre>
    </div>
  </details>

  <details>
    <summary><strong>4) K1..K4</strong></summary>
    <div style="margin-top:10px;">
      <pre>K1 = P - M1
K2 = P - X1
K3 = P - Q
K4 = P - S</pre>
    </div>
  </details>

  <details open>
    <summary><strong>5) K1f (nouveau) — VC / FL / ratio_p</strong></summary>
    <div style="margin-top:10px;">
      <p><strong>Paramètres scénario</strong> : VC (défaut 0.5), FL (défaut 0.5)</p>
      <p><strong>RATIO_P</strong> : indicateur en % (0–100) calculé sur N3/N4. Dans la correction, on utilise <strong>ratio_p = RATIO_P / 100</strong> (donc 0–1).</p>
      <pre>E = M1 - X1
ratio_p = RATIO_P / 100
C = (VC - ratio_p) * FL * E
K1f = K1 + C</pre>
      <p class="muted">Interprétation: si ratio_p &gt; VC, C devient négatif et K1f est “abaissé”; si ratio_p &lt; VC, C est positif et K1f est “rehaussé”.</p>
    </div>
  </details>

  <details>
    <summary><strong>6) Indicateurs de trend: V, slope_P, sum_pos_P, nb_pos_P, RATIO_P, AMP_H</strong></summary>
    <div style="margin-top:10px;">
      <p><strong>Paramètres scénario</strong> : N3, N4</p>
      <ul>
        <li><strong>V</strong> = variation % du close vs le close de la veille (stocké déjà en %)</li>
        <li><strong>slope_P</strong> = moyenne des variations % journalières sur une fenêtre N3</li>
        <li><strong>nb_pos_P</strong> = nombre de slope_P positifs sur les N4 derniers jours</li>
        <li><strong>sum_pos_P</strong> = somme des slope_P positifs sur les N4 derniers jours</li>
        <li><strong>RATIO_P</strong> = nb_pos_P / N4 * 100 (en %)</li>
        <li><strong>AMP_H</strong> = intensité moyenne des hausses (dérivée de sum_pos_P, nb_pos_P, N3) (en %)</li>
      </ul>
      <p class="muted">Ces champs sont affichés dans l’email récapitulatif (RATIO_P / AMP_H).</p>
    </div>
  </details>

  <details>
    <summary><strong>7) K2f (ligne flottante) + alertes A2f/B2f</strong></summary>
    <div style="margin-top:10px;">
      <p><strong>Paramètres scénario</strong>: N5, K2J, CR (et la variable existante e).</p>
      <ul>
        <li><strong>var</strong> = (P(t) - P(t-1)) / P(t-1) (ratio, pas en %)</li>
        <li><strong>slope1</strong> = Σ(var sur N5 jours) × 100</li>
        <li><strong>slope_deg</strong> = slope1 / 90</li>
        <li><strong>h</strong> = max(1, ⌊N5/2⌋)</li>
        <li><strong>Mmax(u)</strong> = max(P sur N5 jours, fenêtre finissant à u)</li>
        <li><strong>Xmin(u)</strong> = min(P sur N5 jours, fenêtre finissant à u)</li>
        <li><strong>Mf1(t)</strong> = moyenne sur h jours de Mmax(u)</li>
        <li><strong>Xf1(t)</strong> = moyenne sur h jours de Xmin(u)</li>
        <li><strong>Ef(t)</strong> = Mf1(t) - Xf1(t)</li>
        <li><strong>FC</strong> = slope_deg × CR × Ef / e</li>
        <li><strong>K2f_pre</strong> = Mf1 - FC</li>
        <li><strong>K2f</strong> = moyenne mobile sur K2J jours de K2f_pre</li>
        <li><strong>diff</strong> = slope2 - slope1, avec slope2 = Σ(var sur h jours) × 100</li>
      </ul>
      <p><strong>Alertes</strong> :</p>
      <ul>
        <li><strong>A2f (achat prudent)</strong>: P croise K2f de bas en haut</li>
        <li><strong>B2f (vente rapide)</strong>: P croise K2f de haut en bas <strong>OU</strong> diff_slope &lt; 0</li>
      </ul>
      <p class="muted">NB: A2f/B2f sont basées sur le croisement de P et K2f (ligne de prix), avec une condition de vente rapide diff_slope < 0.</p>
    </div>
  </details>

    <details>
      <summary><strong>8) V (ligne sur les plus hauts) + alertes I1/J1</strong></summary>
      <p>Cette ligne est basée sur les <strong>plus hauts (High)</strong> des chandelles journalières.</p>
      <ul>
        <li><strong>Paramètre scénario M</strong> (champ <code>m_v</code>) : fenêtre en jours pour le <em>max glissant</em> des High (défaut 20).</li>
        <li><strong>M1</strong> est dérivé : <strong>M1 = M/2</strong> (arrondi inférieur, minimum 1).</li>
        <li><strong>(1) V_pre</strong> = max(High) sur les <strong>M</strong> derniers jours (incluant aujourd'hui).</li>
        <li><strong>(2) V_line</strong> = moyenne mobile sur <strong>M1</strong> jours de V_pre (incluant aujourd'hui).</li>
      </ul>
      <p><strong>Signaux</strong> :</p>
      <ul>
        <li><strong>I1 (achat)</strong> : le High croise la ligne V de bas en haut (High<sub>J-1</sub> &lt; V<sub>J-1</sub> et High<sub>J</sub> &gt; V<sub>J</sub>).</li>
        <li><strong>J1 (vente)</strong> : le High croise la ligne V de haut en bas (High<sub>J-1</sub> &gt; V<sub>J-1</sub> et High<sub>J</sub> &lt; V<sub>J</sub>).</li>
      </ul>
      <p class="muted">NB: comme pour K2f, cette fonctionnalité est <strong>additive</strong> et n'impacte pas les formules legacy K1/K2/K3/K4.</p>
    </details>

  <details open>
    <summary><strong>9) Alertes A1..H1 + A1f/B1f</strong></summary>
    <div style="margin-top:10px;">
      <p>Les alertes sont générées sur <strong>croisement de 0</strong> (changement de signe) entre le jour J-1 et J.</p>
      <ul>
        <li><strong>A1</strong> : K1 croise 0 vers le haut</li>
        <li><strong>B1</strong> : K1 croise 0 vers le bas</li>
        <li><strong>A1f</strong> : K1f croise 0 vers le haut</li>
        <li><strong>B1f</strong> : K1f croise 0 vers le bas</li>
        <li><strong>C1/D1</strong> : K2 croise 0 (haut/bas)</li>
        <li><strong>E1/F1</strong> : K3 croise 0 (haut/bas)</li>
        <li><strong>G1/H1</strong> : K4 croise 0 (haut/bas)</li>
      </ul>
      <p class="muted">Une journée peut contenir plusieurs alertes (champ <code>alerts</code> séparé par des virgules).</p>
    </div>
  </details>

  <details>
    <summary><strong>10) Où ces alertes sont utilisées ? (UI, email, backtests)</strong></summary>
    <div style="margin-top:10px;">
      <ul>
        <li><strong>Page Alertes</strong> : affiche toutes les alertes du jour (incl. A1f/B1f/A2f/B2f) et permet de filtrer/exporter.</li>
        <li><strong>Email quotidien</strong> : envoie un tableau récapitulatif (incl. A1f/B1f/A2f/B2f) + RATIO_P + AMP_H.</li>
        <li><strong>Backtests</strong> : chaque “ligne de signal” BUY/SELL sélectionne un code d’alerte (ex: BUY=A2f / SELL=B2f).</li>
      </ul>
    </div>
  </details>
</div>

<div class="card">
  <h3>Astuce</h3>
  <p class="muted">Pour retrouver ces champs dans les exports: <strong>Alerts</strong> (alertes), <strong>DailyMetrics</strong> (K1..K4, K1f, RATIO_P, etc.).</p>
</div>
{% endblock %}
